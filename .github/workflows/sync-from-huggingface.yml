name: Sync from Hugging Face Space â†’ GitHub

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 23 * * *" # æ¯å¤© 23:00 UTC â‰ˆ å°ç£æ—©ä¸Š 07:00 åŸ·è¡Œï¼Œå»¶é²å¾Œç´„ 09:00 å®Œæˆ

permissions:
  contents: write

env:
  HF_SPACE: soul-heart-dance/chakra-card

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout GitHub repo
        uses: actions/checkout@v4

      - name: Configure git user
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch from Hugging Face Space
        env:
          HUGGINGFACE_TOKEN: ${{ secrets.HF_READ_TOKEN }}
        run: |
          echo "ðŸš€ Cloning Hugging Face Space: $HF_SPACE"
          rm -rf /tmp/hf-space
          git clone https://huggingface.co/spaces/$HF_SPACE /tmp/hf-space

          echo "ðŸ“¦ Fetching LFS objects (for large files like images)..."
          cd /tmp/hf-space
          git lfs pull
          cd -

          echo "ðŸŒ¸ Sync completed. Preparing to push changes to GitHub..."
          echo "ðŸ”§ Running rsync..."

          # âœ… å¾ž /tmp/hf-space â†’ ç•¶å‰ repo è³‡æ–™å¤¾
          rsync -av --delete \
            --ignore-errors \
            --exclude ".git*" \
            --exclude ".github/workflows" \
            /tmp/hf-space/ ./ || true

          echo "ðŸª„ rsync done, updating README timestamp..."

          # === æ›´æ–° README.md çš„æœ€å¾ŒåŒæ­¥æ™‚é–“ ===
          TAIPEI_TIME=$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')
          if grep -q "Last synced from Hugging Face" README.md; then
            sed -i "s|Last synced from Hugging Face:.*|Last synced from Hugging Face: ${TAIPEI_TIME} (Taipei Time)|" README.md
          else
            echo -e "\n---\nâ° Last synced from Hugging Face: ${TAIPEI_TIME} (Taipei Time)" >> README.md
          fi

          echo "ðŸ“¤ Preparing to push changes..."
          git add -A
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit."
          else
            git commit -m "chore(sync): update from HF Space at ${TAIPEI_TIME} (Taipei Time)"
            git push origin main
            echo "âœ… Changes pushed to GitHub."
          fi

      - name: Cleanup
        run: rm -rf /tmp/hf-space
