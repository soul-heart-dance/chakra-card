name: Sync from Hugging Face Space → GitHub

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 23 * * *" # 每天 23:00 UTC ≈ 台灣早上 07:00 執行，延遲後約 09:00 完成

permissions:
  contents: write

env:
  HF_SPACE: soul-heart-dance/chakra-card

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout GitHub repo
        uses: actions/checkout@v4

      - name: Configure git user
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch from Hugging Face Space
        env:
          HUGGINGFACE_TOKEN: ${{ secrets.HF_READ_TOKEN }}
        run: |
          echo "🚀 Cloning Hugging Face Space: $HF_SPACE"
          rm -rf /tmp/hf-space
          git clone https://huggingface.co/spaces/$HF_SPACE /tmp/hf-space

          echo "📦 Fetching LFS objects (for large files like images)..."
          cd /tmp/hf-space
          git lfs pull
          cd -

          echo "🌸 Sync completed. Preparing to push changes to GitHub..."
          echo "🔧 Running rsync..."

          # ✅ 從 /tmp/hf-space → 當前 repo 資料夾
          rsync -av --delete \
            --ignore-errors \
            --exclude ".git*" \
            --exclude ".github/workflows" \
            /tmp/hf-space/ ./ || true

          echo "🪄 rsync done, updating README timestamp..."

          # === 更新 README.md 的最後同步時間 ===
          TAIPEI_TIME=$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')
          if grep -q "Last synced from Hugging Face" README.md; then
            sed -i "s|Last synced from Hugging Face:.*|Last synced from Hugging Face: ${TAIPEI_TIME} (Taipei Time)|" README.md
          else
            echo -e "\n---\n⏰ Last synced from Hugging Face: ${TAIPEI_TIME} (Taipei Time)" >> README.md
          fi

          echo "📤 Preparing to push changes..."
          git add -A
          if git diff --cached --quiet; then
            echo "✅ No changes to commit."
          else
            git commit -m "chore(sync): update from HF Space at ${TAIPEI_TIME} (Taipei Time)"
            git push origin main
            echo "✅ Changes pushed to GitHub."
          fi

      - name: Cleanup
        run: rm -rf /tmp/hf-space
