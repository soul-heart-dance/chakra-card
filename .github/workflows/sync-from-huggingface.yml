name: Sync from Hugging Face Space â†’ GitHub

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 1 * * *" # æ¯å¤© 01:00 UTC = å°ç£æ—©ä¸Š 09:00

permissions:
  contents: write

env:
  HF_SPACE: soul-heart-dance/chakra-card

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout GitHub repo
        uses: actions/checkout@v4

      - name: Configure git user
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch from Hugging Face Space
        env:
          HUGGINGFACE_TOKEN: ${{ secrets.HF_READ_TOKEN }}
        run: |
          echo "ðŸš€ Cloning Hugging Face Space: $HF_SPACE"
          rm -rf hf-space
          git clone https://huggingface.co/spaces/$HF_SPACE hf-space

          cd hf-space
          echo "ðŸ“¦ Fetching LFS objects (for large files like images)..."
          git lfs pull
          cd ..

          echo "ðŸŒ¸ Sync completed. Preparing to push changes to GitHub..."
          # ðŸ©· åŠ ä¸Š ignore-errors + || true é˜²æ­¢ã€Œfile vanishedã€ä¸­æ–·
          rsync -a --delete --ignore-errors --exclude ".git*" --exclude ".github/workflows" ./hf-space/ ./ || true

          # === æ›´æ–° README.md çš„æœ€å¾ŒåŒæ­¥æ™‚é–“ ===
          TAIPEI_TIME=$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')
          if grep -q "Last synced from Hugging Face" README.md; then
            sed -i "s|Last synced from Hugging Face:.*|Last synced from Hugging Face: ${TAIPEI_TIME} (Taipei Time)|" README.md
          else
            echo -e "\n---\nâ° Last synced from Hugging Face: ${TAIPEI_TIME} (Taipei Time)" >> README.md
          fi

          # === Commit & Push ===
          git add -A
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit."
          else
            git commit -m "chore(sync): update from HF Space at ${TAIPEI_TIME} (Taipei Time)"
            git push origin main
          fi

      - name: Cleanup
        run: rm -rf hf-space
